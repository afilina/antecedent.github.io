<!DOCTYPE html>
<html>
<head>
    <title>Static Methods, Testability and Monkey Patching - Patchwork</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="../style.css" type="text/css">

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-20483190-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</head>
<body>
    <div id="nav">
        <a href="requirements.html">Requirements</a>
        <a href="setup.html">Setup</a>
        <a href="usage.html">Usage</a>
        <a href="implementation.html">Implementation</a>
        <a href="changelog.html">Changelog</a>
        <a href="license.html">License</a>
    </div>

    <div id="top-outer" class="for-docs">
        <div id="top">
            <div id="square-pattern">
                <div style="background: rgb(190,216,244);"></div>
                <div style="background: rgb(191,216,242);"></div>
                <div style="background: rgb(189,212,240);"></div>
                <div style="background: rgb(191,213,245);"></div>
                <div style="background: rgb(194,216,236);"></div>
                <div style="background: rgb(184,210,249);"></div>
                <div style="background: rgb(196,210,243);"></div>
                <div style="background: rgb(184,218,249);"></div>
                <div style="background: rgb(192,209,253);"></div>
                <div style="background: rgb(193,210,245);"></div>
                <div style="background: rgb(187,219,247);"></div>
                <div style="background: rgb(188,215,246);"></div>
                <div style="background: rgb(189,217,242);"></div>
                <div style="background: rgb(190,216,244);"></div>
                <div style="background: rgb(190,216,244);"></div>
                <div style="background: rgb(191,216,245);"></div>
                <div style="background: rgb(187,218,243);"></div>
                <div style="background: rgb(192,218,240);"></div>
                <div style="background: rgb(192,219,250);"></div>
                <div style="background: rgb(188,221,235);"></div>
                <div style="background: rgb(185,213,250);"></div>
                <div style="background: rgb(200,221,244);"></div>
                <div style="background: rgb(181,213,243);"></div>
                <div style="background: rgb(187,218,239);"></div>
                <div style="background: rgb(187,215,238);"></div>
                <div style="background: rgb(189,212,240);"></div>
            </div>
            <div id="header">
                <h1><a href="../">Patchwork</a></h1>
            </div>
        </div>
    </div>

    <div id="main-outer">
        <div id="main">
            <h3>Static Methods, Testability and Monkey Patching</h4>

            <div class="separator"></div>

            <div class="important-box">
                <div class="icon"><img src="../icons/attention.png" alt="Attention!"></div>
                <div class="content">
                    <p class="one-liner">This article has been deprecated.</p>
                </div>
            </div>

<p>Because of the way PHP works, static method calls are often seen as a <a href="http://googletesting.blogspot.com/2008/12/static-methods-are-death-to-testability.html">major testability obstacle</a> in PHP code. Unlike in Ruby or JavaScript, classes in PHP are completely closed upon definition, so static methods cannot be stubbed (that is, replaced with test stubs) in any natural way. Therefore, any cross-class static method call is essentially a hardcoded dependency in PHP.</p>

<p>In most cases, but by no means in all of them, hardcoded dependencies mean not only poor testability, but also bad component design, which is why <strong>public</strong> static methods should be avoided in object-oriented PHP code in general. Unfortunately, just avoiding them yourself will probably not make them disappear from your code altogether. Lots of third-party libraries have static methods in their public APIs as well, so just using such libraries will inevitably result in a number of stubborn dependencies.</p>

<p>Rails-inspired <a href="http://ar.rubyonrails.org">Active Record</a> libraries, found in many web application frameworks, make for a perfect example. If you want a list of all users, just call <kbd>User::all()</kbd>. Call it from anywhere: controllers, logging callbacks, authentication layers, just anywhere. APIs like this shine with simplicity, yet they also tend to ruin the testability of any code that uses them.</p>

<p>Fortunately, with the help of proper tools, testability and procedural APIs can still coexist in your code. One of such tools is the <a href="http://www.php.net/manual/en/book.runkit.php">Runkit</a> extension, or more specifically, its <kbd><a href="http://www.php.net/manual/en/function.runkit-method-redefine.php">runkit_method_redefine</a></kbd> function:</p>

<pre>runkit_method_redefine<span class="noise">(</span><span class="string">"User"</span>, <span class="string">"all"</span>, <span class="string">""</span>, <span class="string">"return array();"</span><span class="noise">)</span>;</pre>

<p>Now you can see that stubbing static methods is possible, after all. However, it just does not feel natural this way. That is because such runtime code manipulations, which go by the name of <a href="http://en.wikipedia.org/wiki/Monkey_patch">monkey patching</a>, are not a native capability of PHP. While we could achieve the same effect by <a href="http://codepad.org/F4E9D2wF">literally redefining</a> the method in Ruby and some other languages, we need a specialized core extension to do that in PHP.</p>

<p>But that is not entirely true, because now there is also <a href="https://github.com/antecedent/patchwork">Patchwork</a>.</p>

<p>Patchwork is an open source attempt to port the functionality of <kbd><a href="http://www.php.net/manual/en/function.runkit-function-redefine.php">runkit_function_redefine</a></kbd> and <kbd><a href="http://www.php.net/manual/en/function.runkit-method-redefine.php">runkit_method_redefine</a></kbd> to native PHP, eliminating the need for special core extensions. However, this unlimited portability comes at a price, as Patchwork is not capable of redefining internal PHP functions and methods, like <kbd><a href="http://php.net/date">date</a></kbd> and <kbd><a href="http://php.net/ArrayIterator.current">ArrayIterator::current</a></kbd>. But since we are dealing with a user-defined method here, Patchwork will do for us:</p>

<pre>
Patchwork<span class="noise">\</span>replace<span class="noise">(</span><span class="string">"User::all"</span>, <span class="keyword">function</span><span class="noise">(</span><span class="noise">)</span>
<span class="noise">{</span>
    <span class="keyword">return</span> <span class="keyword">array</span><span class="noise">(</span><span class="noise">)</span>;
<span class="noise">}</span><span class="noise">)</span>;</pre>

<p>While we are at it, let's see a trivial, yet complete PHPUnit test case involving Patchwork:</p>

<pre>
<span class="keyword">function</span> <span class="identifier">countUsers</span><span class="noise">(</span><span class="noise">)</span>
<span class="noise">{</span>
    <span class="keyword">return</span> <span class="identifier">count</span><span class="noise">(</span><span class="identifier">User</span><span class="noise">::</span><span class="identifier">all</span><span class="noise">(</span><span class="noise">)</span><span class="noise">)</span>;
<span class="noise">}</span>

<span class="keyword">class</span> <span class="identifier">UserCountingTest</span> <span class="keyword">extends</span> <span class="identifier">PHPUnit_Framework_TestCase</span>
<span class="noise">{</span>
    <span class="keyword">function</span> <span class="identifier">testWithNoUsers</span><span class="noise">(</span><span class="noise">)</span>
    <span class="noise">{</span>
        <span class="identifier">Patchwork</span><span class="noise">\</span><span class="identifier">replace</span><span class="noise">(</span><span class="string">"User::all"</span>, <span class="keyword">function</span><span class="noise">(</span><span class="noise">)</span> <span class="noise">{</span> <span class="keyword">return</span> <span class="keyword">array</span><span class="noise">(</span><span class="noise">)</span>; <span class="noise">}</span><span class="noise">)</span>;
        <span class="keyword">$this</span><span class="noise">-></span><span class="identifier">assertEquals</span><span class="noise">(</span><span class="number">0</span>, <span class="identifier">countUsers</span><span class="noise">(</span><span class="noise">)</span><span class="noise">)</span>;
    <span class="noise">}</span>

    <span class="keyword">function</span> <span class="identifier">testWithOneUser</span><span class="noise">(</span><span class="noise">)</span>
    <span class="noise">{</span>
        <span class="identifier">Patchwork</span><span class="noise">\</span><span class="identifier">replace</span><span class="noise">(</span><span class="string">"User::all"</span>, <span class="keyword">array</span><span class="noise">(</span><span class="keyword">$this</span>, <span class="string">"getOneFakeUser"</span><span class="noise">)</span><span class="noise">)</span>;
        <span class="keyword">$this</span><span class="noise">-></span><span class="identifier">assertEquals</span><span class="noise">(</span><span class="number">1</span>, <span class="identifier">countUsers</span><span class="noise">(</span><span class="noise">)</span><span class="noise">)</span>;
    <span class="noise">}</span>

    <span class="keyword">function</span> <span class="identifier">getOneFakeUser</span><span class="noise">(</span><span class="noise">)</span>
    <span class="noise">{</span>
        <span class="keyword">return</span> <span class="keyword">array</span><span class="noise">(</span><span class="keyword">new</span> <span class="identifier">StdClass</span><span class="noise">)</span>;
    <span class="noise">}</span>

    <span class="comment">/**
     * Reverses all redefinitions after each test method.
     */</span>
    <span class="keyword">function</span> <span class="identifier">tearDown</span><span class="noise">(</span><span class="noise">)</span>
    <span class="noise">{</span>
        <span class="identifier">Patchwork</span><span class="noise">\</span><span class="identifier">undoAll</span><span class="noise">(</span><span class="noise">)</span>;
    <span class="noise">}</span>
<span class="noise">}</span></pre>

<p>Although our example with Active Record ends here, there is a lot more you can do with the help of monkey patching, like replacing singleton instances and stubbing instance methods on all instances of a class. However, you should always think twice before doing so. Monkey patching should only be considered in cases when actually making the code testable requires unreasonable effort. In essence, monkey patching means making code testable "by force", and not by design, which is why it should only be a last-resort solution. And finally, <strong>please never, ever use it in production code</strong>. Monkey patching is hacky enough to be restricted to testing environments.</p>

<p>And that will probably be enough for now.</p>

<p>Happy testing!</p>


            <div class="separator"></div>

            <div id="disqus_thread"></div>
            <script type="text/javascript">
            var disqus_shortname = 'antecedentgithub';
            var disqus_identifier = '/patchwork/blog/static-methods.html';
            var disqus_url = 'http://antecedent.github.com/patchwork/blog/static-methods.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>
</body>
</html>
